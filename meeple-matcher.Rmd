---
title: "meep-matcher.Rmd"
author: "mikec964"
date: "8/1/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
file.sources = list.files(c("scripts"),
                          pattern="*.R$", full.names=TRUE,
                          ignore.case=TRUE)
sapply(file.sources, source)
```

# Overview
Here's the plan, so far:

1. **Load the customer's collection.**  
Load the collection of games (and ratings) of the user. All users are gamers,
but the person we're building the recommendation for is the customer.
We'll build a Collections table with a row per game.

2. **Per game, load the ratings.**  
For each game in the customer's collection, get the gamers that also rated
it. Row per gamer/rating.

    * Request all of these in parallel, pause, then load what we can  
    * Add to Ratings table

3. **Rank gamers that are like the customer.**

4. **Per ranking, load the gamer's collections.**  
For gamers that are similar to the customer, load their collections. Games
in their collections that are unknown to the customer are possible
recommendations.

    * Request all of these in parallel, pause, then load what we can


# Load the customer's collection
This is probably in the range of 10 to 200 games. 
Note that for some customers, the number of columns might be different.
If a customer has a game with wishlist=1, then for that row the column
"wishlistpriority" is added.

```{r echo=TRUE, message=TRUE, warning=TRUE}
customer <- "mikec"
collection.tbl <- GetGamerCollection(customer)
head(collection.tbl)
#eg.tbl <- GetGamerCollection("educatedgravy")
#head(eg.df)
```
# Per game, load the ratings
We'll build a narrow ratings table with game.id, gamer, and rating columns.
Possible problems ahead:

* Each game could have 10,000 or more ratings...

    * Reading ratings 100 at a time (per API) means 100 queries  
    * If the customer has 100 games, that's 10,000 queries!

* Since ratings are sorted best to worst, and delivered in pages of 100,
we could:

    * Stop getting ratings below 5  
    * Select some pages to sample

For now:

  * Load the first page of (100) ratings per game  
  * Load a sample from the customer's collection

```{r echo=TRUE, message=TRUE, warning=TRUE}
s <- 10
sample.tbl <- sample_n(collection.tbl, s)
for(game in 1:s) {
  message(sprintf("\nLoading ratings for %s: %s.", sample.tbl[game, "game"], sample.tbl[game, "game.id"]))
  game.ratings.tbl <- GetGameRatings(sample.tbl[[game, "game.id"]])
  if(game == 1) {
    ratings.tbl <- game.ratings.tbl
  } else {
    ratings.tbl <- bind_rows(ratings.tbl, game.ratings.tbl)
  }
}
head(ratings.tbl)
```

# Rank gamers that are like the customer
The general formula is:  
  * For the games we have rated, find gamers who have rated them similarly  
  * The more games they agree with us on, the better

```{r echo=FALSE, message=TRUE, warning=TRUE}

```

# Per rating, load the gamer's collections
We should make a unique list of gamer IDs that have rated games, then load
their collections.

```{r echo=FALSE, message=TRUE, warning=TRUE}

```

