---
title: "meep-matcher.Rmd"
author: "mikec964"
date: "7/19/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview
Here's the plan, so far:
1. Load the collection of games (and ratings) of the user/gamer, "customer". Row per game.
2. For each game in the customer's collection, get the gamers that rated it. Row per gamer/rating.
    * We might request all of these in parallel, pause, then load what we can
    * Add to table, some columns empty.
3. For each of those gamers, load their collections (and ratings)
    * Request all, pause, load
    * Extend and update table

```{r setup, include=FALSE}
library(dplyr)
```

# Load data for two users
We're loading two just to make sure this works on n+1 cases.

Note that number of columns might be different. This might happen if one user has some games on wishlist=1, then the column "wishlistpriority" is added.

```{r echo=FALSE, message=FALSE, warning=FALSE}
source("scripts/get_gamer_collection.R")
customer <- "mikec"
collection.tbl <- GetGamerCollection(customer)
head(collection.tbl)
#eg.tbl <- GetGamerCollection("educatedgravy")
#head(eg.df)
```
# For each game in the customer collection, get the ratings
We'll append these rows to our customer collection table. Possible problems ahead:
* Each game could have 10,000 or more ratings...
  * 100 games is a million rows
  * Reading ratings 100 at a time (per API) means 10,000 queries!
* On the new rows the gamer, game, game_id, rating columns will be filled, but
the own, owned, wishlist columns will be empty until we load data for each gamer
* Since ratings are sorted best to worst, and delivered in pages of 100, we could:
  * Stop getting ratings below 5
  * Select some pages to sample

For now:
 * Load the first page of (100) ratings
 * Only load for the first game in the customer collection, until this works

```{r echo=FALSE, message=FALSE, warning=FALSE}
source("scripts/get_game_ratings.R")
ratings.tbl <- GetGameRatings(collection.tbl[1,"game.id"])
head(ratings.tbl)
```

# Combine customer game ratings with other gamer's ratings
Now, we want to combine these rows with the main collection table. This will be unnecessarily ugly. We'll rearrange and add columns (with NAs) to the game_ratings.tbl until it looks like collection.tbl.

```{r echo=FALSE, message=FALSE, warning=FALSE}
na.col <- rep(NA, dim(collection.tbl)[1])
add_cols <- setdiff(colnames(collection.tbl), colnames(ratings.tbl))
wide_ratings <- ratings.tbl

#for(c in add_cols) {
#  print(c)
#  wide_ratings <- add_column(wide_ratings, na.col)
#}
```

