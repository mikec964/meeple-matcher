---
title: "Meeple Matcher Statistics"
author: "mikec964"
date: "7/20/2018"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list=ls())
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)

source("scripts/restore_data.R")
```

# Compare collection sizes
The project goal is to make game recommendations for the customer.

How does the collection size of the customer compare to other gamers?
In this case we loaded the collections for all gamers who had at least one game
in common with the customer.

This resulted in loading 158K gamers who had rated 1.385 million games. The
customer has 160 games in their collection, though only 60 are rated.
Collections were loaded for 1000 random gamers.
```{r collection size histogram, echo=FALSE, message=TRUE, warning=TRUE}
collection_size_tbl <- gamer_collections_tall %>%
  group_by(gamer) %>%
  count(sort = TRUE) %>%
  arrange(n)
ggplot(collection_size_tbl, aes(n)) +
  geom_histogram(binwidth = 10) +
  labs(
    title = "Sizes of Game Collections (of 1000 gamers)",
    x = "Games", y = "No. of Gamers"
  )
ggplot(collection_size_tbl[1:500, ], aes(n)) +
  geom_histogram(binwidth = 5) +
  labs(
    title = "Sizes of Game Collections (of bottom 500 gamers)",
    x = "Games", y = "No. of Gamers"
  )
ggplot(collection_size_tbl[501:1000, ], aes(n)) +
  geom_histogram(binwidth = 5) +
  labs(
    title = "Sizes of Game Collections (of top 500 gamers)",
    x = "Games", y = "No. of Gamers"
  )

```

```{r collection size quintiles, echo=FALSE, message=TRUE, warning=TRUE}
# q10_qty_tbl <- gamer_collections_tall %>%
#   # 10 quantiles by #games per gamer
#   count(gamer) %>%
#   arrange(n) %>%
#   mutate(quant = rep(1:10, each=ceiling(length(gamer)/10))) %>%
#   # mean collection size per quintile
#   group_by(quant) %>%
#   summarize(games_mu = as.integer(mean(n, na.rm=TRUE)),
#             games_sd = as.integer(sd(n, na.rm=TRUE)),
#             games_max = max(n, na.rm=TRUE))
# ggplot(data=q10_qty_tbl, mapping=aes(x=quant, y=games_mu)) +
#   scale_x_continuous(breaks=seq(1,10)) +
#   scale_y_continuous(breaks=seq(0,1300, by=100)) +
#   labs(title="Games Rated per Gamer", x="Quantile", y="Mean") +
#   geom_col() +
#   geom_text(aes(x=quant, y=games_mu + 60, label=games_mu))
```

# Compare customer ratings to most ratings
These charts show that ratings from the customer and other gamers both follow
a normal distribution, slightly skewed left.
```{r Bar chart of games per rating, echo=FALSE, message=TRUE, warning=TRUE}
rating_props_tbl <- game_ratings_tall %>%
  mutate(is_customer = (gamer == customer)) %>%
  group_by(rating, is_customer) %>%
  summarize(n = sum(rating)) %>%
  group_by(is_customer) %>%
  mutate(prop = n / sum(n)) %>% # proportion of customer or non-customer votes
  filter(rating > 0)

ggplot(rating_props_tbl, aes(x = rating, y = prop, fill = is_customer)) +
  labs(title = "Game Ratings (1-10)", x = NULL, y = "Percentage") +
  scale_fill_discrete(name = "Gamer", labels = c("By others", "By customer")) +
  scale_x_continuous(breaks = seq(1, 10)) +
  scale_y_continuous(labels = percent_format()) +
  geom_col(position = "dodge")
# note: ratings are screwed left

# Also calc rating per game by customer and by others
game_ratings1_tbl <- gamer_collections_tall %>%
  filter(gamer == customer) %>%
  filter(!is.na(rating)) %>%
  select(game.id, rating) %>%
  rename(cust_rating = rating)

game_ratings_tbl <- gamer_collections_tall %>%
  group_by(game.id) %>%
  summarize(all_rating = mean(rating, na.rm = TRUE)) %>%
  filter(!is.nan(all_rating)) %>%
  full_join(game_ratings1_tbl, by = "game.id")
# result: 27k games (16K rated, 8K with >1 rating)

```


# Rating per game
Next, we learn a little more about what kinds of games the customer likes.
Games have *mechanics*, like card-drafting, dice-rolling, and tile-laying. They
also have *categories* like science-fiction, co-operative, and family.

First we look at which mechanics are most common in the customer's collection.
```{r Plot games per mechanic, echo=FALSE, message=TRUE, warning=TRUE}
# game_attrs is tall, make it tidy with observation per game
get_attrs <- function(df_tall, sel_attr) {
  # Use this to get "boardgamemechanic" or "boardgamecategory"
  attrs_tall <- df_tall %>%
  group_by(game.id) %>%
  filter(key == sel_attr) %>%
  select(-one_of("key")) %>%
  rename(attr=value)
}
get_counts <- function(df_tall, max_n) {
  counts_tall <- df_tall %>%
  group_by(attr) %>%
  summarize(n=n()) %>%
  arrange(n) %>%
  # top 20 mechanics
  top_n(20, n)
}

game_mechs_tall <- get_attrs(game_attrs_tall, "boardgamemechanic")
mech_counts_tbl <- get_counts(game_mechs_tall, 20)

ggplot(mech_counts_tbl, aes(reorder(attr, n), n)) +
  labs(title="Games per Mechanic", x="Top 20 Mechanics", y=NULL) +
  geom_col(fill="blue") +
  coord_flip()
```

For each mechanic, this chart shows the difference between the
customer and the overall rating.
```{r Plot ratings per mech, echo=FALSE, message=TRUE, warning=TRUE}
get_ratings <- function(df_tall, ratings_tbl) {
  df_tall$all_rating <- sapply(df_tall$game.id, function(x){
    as.numeric(ratings_tbl[ratings_tbl$game.id == x, "all_rating"])
  })
  df_tall$cust_rating <- sapply(df_tall$game.id, function(x){
    as.numeric(ratings_tbl[ratings_tbl$game.id == x, "cust_rating"])
  })
  ratings_tbl <- df_tall %>%
  # cols will be games, values will be game ratings
  group_by(attr) %>%
  summarize(cust_rating = mean(cust_rating, na.rm=TRUE),
            all_rating = mean(all_rating, na.rm=TRUE)) %>%
  filter(!is.na(cust_rating)) %>% # drop mechanics not rated
  mutate(pref = cust_rating - all_rating)
}
mech_ratings_tbl <- get_ratings(game_mechs_tall, game_ratings_tbl)

ggplot(mech_ratings_tbl, aes(reorder(attr, pref), pref)) +
  labs(title="Customer's Preferred Mechanics", x="Mechanic", 
       y="Rating by Customer - Rating by Others") +
  theme(legend.position="bottom") +
  geom_point() +
  geom_segment(aes(x=1, xend=nrow(mech_ratings_tbl), y=0, yend=0), 
               color="blue") +
  coord_flip()
```

# Games per category
I look at game categories the same way. Which categories are often selected?
```{r games per category, echo=FALSE, message=TRUE, warning=TRUE}
game_gcats_tall <- get_attrs(game_attrs_tall, "boardgamecategory")
gcat_counts_tbl <- get_counts(game_gcats_tall, 20)

ggplot(gcat_counts_tbl, aes(reorder(attr, n), n)) +
  labs(title="Games per Category", x="Top 20 Categories", y=NULL) +
  geom_col(fill="purple") +
  coord_flip()
```

```{r Plot ratings per category, echo=FALSE, message=TRUE, warning=TRUE}
gcat_ratings_tbl <- get_ratings(game_gcats_tall, game_ratings_tbl)

ggplot(gcat_ratings_tbl, aes(reorder(attr, pref), pref)) +
  labs(title="Customer's Preferred Categories", x="Category", 
       y="Rating by Customer - Rating by Others") +
  theme(legend.position="bottom") +
  geom_point() +
  geom_segment(aes(x=1, xend=nrow(gcat_ratings_tbl), y=0, yend=0),
               color="purple") +
  coord_flip()
```
The customer has mostly science fiction games and rates them higher, and few
movie-themed games rated lower. There are counter-examples, too: Miniatures
games are purchased infrequently but highly rated.

This might be an opportunity to recommend a type of game to play.
