---
title: "Meeple Matcher Statistics"
author: "mikec964"
date: "7/20/2018"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list=ls())
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)

source("scripts/restore_data.R")
```

# Compare collection sizes
The project goal is to make game recommendations for the customer.

How does the collection size of the customer compare to other gamers?
In this case we loaded the collections for all gamers who had at least one game
in common with the customer.

This resulted in loading 158K gamers who had rated 1.385 million games. The
customer has 160 games in their collection, though only 60 are rated.
Collections were loaded for 1000 random gamers.
```{r collection size histogram, echo=FALSE, message=TRUE, warning=TRUE}
collection_size_tbl <- gamer_collections_tall %>%
  group_by(gamer) %>%
  count(sort = TRUE) %>%
  arrange(n)
ggplot(collection_size_tbl, aes(n)) +
  geom_histogram(binwidth = 10) +
  labs(
    title = "Sizes of Game Collections (of 1000 gamers)",
    x = "Games", y = "No. of Gamers"
  )
ggplot(collection_size_tbl[1:800, ], aes(n)) +
  geom_histogram(binwidth = 10) +
  labs(
    title = "Sizes of Game Collections (of bottom 800 gamers)",
    x = "Games", y = "No. of Gamers"
  )

```

```{r collection size quintiles, echo=FALSE, message=TRUE, warning=TRUE}
# q10_qty_tbl <- gamer_collections_tall %>%
#   # 10 quantiles by #games per gamer
#   count(gamer) %>%
#   arrange(n) %>%
#   mutate(quant = rep(1:10, each=ceiling(length(gamer)/10))) %>%
#   # mean collection size per quintile
#   group_by(quant) %>%
#   summarize(games_mu = as.integer(mean(n, na.rm=TRUE)),
#             games_sd = as.integer(sd(n, na.rm=TRUE)),
#             games_max = max(n, na.rm=TRUE))
# ggplot(data=q10_qty_tbl, mapping=aes(x=quant, y=games_mu)) +
#   scale_x_continuous(breaks=seq(1,10)) +
#   scale_y_continuous(breaks=seq(0,1300, by=100)) +
#   labs(title="Games Rated per Gamer", x="Quantile", y="Mean") +
#   geom_col() +
#   geom_text(aes(x=quant, y=games_mu + 60, label=games_mu))
```

# Compare customer ratings to most ratings
These charts show that ratings from the customer and other gamers both follow
a normal distribution, slightly skewed left.
```{r Bar chart of games per rating, echo=FALSE, message=TRUE, warning=TRUE}
rating_props_tbl <- bg_ratings_tall %>%
  mutate(is_customer = (gamer == customer)) %>%
  group_by(rating, is_customer) %>%
  summarize(n = sum(rating)) %>%
  group_by(is_customer) %>%
  mutate(prop = n / sum(n)) %>% # proportion of customer or non-customer votes
  filter(rating > 0)

ggplot(rating_props_tbl, aes(x = rating, y = prop, fill = is_customer)) +
  labs(title = "Game Ratings (1-10)", x = NULL, y = "Percentage") +
  scale_fill_discrete(name = "Gamer", labels = c("By others", "By customer")) +
  scale_x_continuous(breaks = seq(1, 10)) +
  scale_y_continuous(labels = percent_format()) +
  geom_col(position = "dodge")
# note: ratings are screwed left
```

```{r Bar chart of games per rating, echo=FALSE, message=TRUE, warning=TRUE}
# Also calc rating per game by customer and by others
bg_ratings_tbl <- gamer_collections_tall %>%
  filter(!is.na(rating)) %>%
  select(game.id, gamer, rating) %>%
  mutate(is_cust = (gamer == customer),
         c_rating = is_cust * rating,
         c_rating = na_if(c_rating, 0),
         a_rating  = (!is_cust) * rating,
         a_rating  = na_if(a_rating, 0))
bg_ratings_tbl <- bg_ratings_tbl %>%
  group_by(game.id) %>%
  summarize(n = n(),
            cust_rating = sum(c_rating, na.rm = TRUE),
            cust_rating = na_if(cust_rating, 0),
            all_ratings  = mean(a_rating, na.rm = TRUE))
# result: Of 27k games, 16K rated, 8K with >1 rating

```


# Rating per game
Next, we learn a little more about what kinds of games the customer likes.
Games have *mechanics*, like card-drafting, dice-rolling, and tile-laying. They
also have *categories* like science-fiction, co-operative, and family.

First we look at which mechanics are most common in the customer's collection.
```{r Plot games per mechanic, echo=FALSE, message=TRUE, warning=TRUE}
#' Get a list of values for an attribute
#'
#' @param bg_attr "boardgamemechanic" or "boardgamecategory"
#' @param bg_attrs_tall A tall table of game.id and key/value pairs.
#' @param bg_ratings_tbl A table of games with customer and overall ratings.
#' @return A table of values and count of games with that value.
get_attr_stats <- function(bg_attr, 
                           attrs_tall = bg_attrs_tall, 
                           ratings_tbl = bg_ratings_tbl) {
  attr_stats <- attrs_tall %>%
    # tall with game.id * attribute (mechanic) rows,
    #     n (count of ratings), cust_rating, all_ratings
    group_by(game.id) %>%
    filter(key == bg_attr) %>%
    select(-one_of("key")) %>%
    inner_join(ratings_tbl, by = "game.id")
  
  attr_stats2 <- attr_stats %>%
    # table of attribute values (mechanics),
    #   n_games (games with attr value)
    group_by(value) %>%
    summarize(n_games = n(),
              n_ratings = sum(n),
              cust_rating_wt = mean(cust_rating, na.rm = TRUE),
              all_ratings_wt = sum(all_ratings * n) / sum(n)) %>%
    arrange(desc(cust_rating_wt))

  # Is this n_games overall or n_games by customer?
}

mech_ratings_tbl <- get_attr_stats("boardgamemechanic")
mech_ratings_tbl <- subset(mech_ratings_tbl, !is.na(cust_rating_wt))
ggplot(mech_ratings_tbl[1:25, ], aes(reorder(value, n_games), n_games)) +
  labs(title="Games per Mechanic", x="Top 20 Mechanics", y=NULL) +
  geom_col(fill="blue") +
  coord_flip()
```

For each mechanic, this chart shows the difference between the
customer and the overall rating.
```{r Plot ratings per mech, echo=FALSE, message=TRUE, warning=TRUE}
mech_ratings_tbl$pref <- mech_ratings_tbl$cust_rating_wt - mech_ratings_tbl$all_ratings_wt
ggplot(mech_ratings_tbl[1:25, ], aes(reorder(value, pref), pref)) +
  labs(title="Customer's Preferred Mechanics", x="Mechanic", 
       y="Rating by Customer - Rating by Others") +
  theme(legend.position="bottom") +
  geom_point() +
  geom_segment(aes(x=1, xend=25, y=0, yend=0), 
               color="blue") +
  coord_flip()
```

# Games per category
I look at game categories the same way. Which categories are often selected?
```{r games per category, echo=FALSE, message=TRUE, warning=TRUE}
gcat_ratings_tbl <- get_attr_stats("boardgamecategory")
gcat_ratings_tbl <- subset(gcat_ratings_tbl, !is.na(cust_rating_wt))
ggplot(gcat_ratings_tbl[1:25,], aes(reorder(value, n_games), n_games)) +
  labs(title="Games per Category", x="Top 20 Categories", y=NULL) +
  geom_col(fill="purple") +
  coord_flip()
```

```{r Plot ratings per category, echo=FALSE, message=TRUE, warning=TRUE}
gcat_ratings_tbl$pref <- gcat_ratings_tbl$cust_rating_wt - gcat_ratings_tbl$all_ratings_wt
ggplot(gcat_ratings_tbl[1:25, ], aes(reorder(value, pref), pref)) +
  labs(title="Customer's Preferred Categories", x="Category", 
       y="Rating by Customer - Rating by Others") +
  theme(legend.position="bottom") +
  geom_point() +
  geom_segment(aes(x=1, xend=25, y=0, yend=0),
               color="purple") +
  coord_flip()
```
The customer has mostly science fiction games and rates them higher, and few
movie-themed games rated lower. There are counter-examples, too: Miniatures
games are purchased infrequently but highly rated.

This might be an opportunity to recommend a type of game to play.
